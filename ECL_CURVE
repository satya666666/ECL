import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } from 'recharts';
import { AlertCircle, TrendingUp, TrendingDown, User, LogOut, FileText, BarChart3, Upload } from 'lucide-react';

const LoanECLAnalyzer = () => {
  const [user, setUser] = useState(null);
  const [loginForm, setLoginForm] = useState({ username: '', password: '', role: 'analyst' });
  const [loanData, setLoanData] = useState([]);
  const [selectedSegment, setSelectedSegment] = useState('all');
  const [analysis, setAnalysis] = useState(null);
  const [loading, setLoading] = useState(false);
  const [reports, setReports] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard');

  // Mock users - In production, use proper authentication
  const users = {
    analyst1: { password: 'analyst123', role: 'analyst', name: 'John Analyst' },
    analyst2: { password: 'analyst123', role: 'analyst', name: 'Jane Analyst' },
    cro: { password: 'cro123', role: 'cro', name: 'Chief Risk Officer' }
  };

  useEffect(() => {
    loadStoredData();
  }, []);

  const loadStoredData = async () => {
    try {
      const storedReports = await window.storage.list('report:', false);
      if (storedReports && storedReports.keys) {
        const reportPromises = storedReports.keys.map(key => window.storage.get(key, false));
        const reportResults = await Promise.all(reportPromises);
        const loadedReports = reportResults
          .filter(r => r && r.value)
          .map(r => JSON.parse(r.value))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        setReports(loadedReports);
      }
    } catch (error) {
      console.log('No previous reports found');
    }
  };

  const handleLogin = (e) => {
    e.preventDefault();
    const userCredentials = users[loginForm.username];
    if (userCredentials && userCredentials.password === loginForm.password) {
      setUser({ username: loginForm.username, ...userCredentials });
    } else {
      alert('Invalid credentials');
    }
  };

  const handleLogout = () => {
    setUser(null);
    setAnalysis(null);
    setActiveTab('dashboard');
  };

  const processCSVData = (csvText) => {
    const lines = csvText.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    
    const data = lines.slice(1)
      .filter(line => line.trim())
      .map(line => {
        const values = line.split(',');
        const row = {};
        headers.forEach((header, i) => {
          row[header] = values[i]?.trim() || '';
        });
        return row;
      });

    return data;
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const csvData = event.target.result;
        const parsed = processCSVData(csvData);
        setLoanData(parsed);
        alert(`Loaded ${parsed.length} loan records`);
      };
      reader.readAsText(file);
    }
  };

  const calculateECL = (loans) => {
    // Simplified ECL calculation based on loan status and credit policy
    const segments = {};
    
    loans.forEach(loan => {
      const purpose = loan.purpose || loan.Purpose || 'unknown';
      const status = (loan.not_fully_paid || loan['not.fully.paid']) === '1' ? 'default' : 'paid';
      const amount = parseFloat(loan.loan_amnt || loan['loan.amnt'] || 0);
      const creditPolicy = (loan.credit_policy || loan['credit.policy']) === '1';
      
      if (!segments[purpose]) {
        segments[purpose] = {
          totalLoans: 0,
          totalAmount: 0,
          defaults: 0,
          defaultAmount: 0,
          avgInterest: 0,
          interestSum: 0,
          noCreditPolicy: 0
        };
      }
      
      segments[purpose].totalLoans++;
      segments[purpose].totalAmount += amount;
      segments[purpose].interestSum += parseFloat(loan.int_rate || loan['int.rate'] || 0);
      
      if (status === 'default') {
        segments[purpose].defaults++;
        segments[purpose].defaultAmount += amount;
      }
      
      if (!creditPolicy) {
        segments[purpose].noCreditPolicy++;
      }
    });

    // Calculate ECL metrics
    Object.keys(segments).forEach(key => {
      const seg = segments[key];
      seg.defaultRate = (seg.defaults / seg.totalLoans) * 100;
      seg.avgInterest = seg.interestSum / seg.totalLoans;
      seg.ecl = (seg.defaultAmount / seg.totalAmount) * 100;
      seg.riskScore = seg.defaultRate * 0.6 + (seg.noCreditPolicy / seg.totalLoans) * 40;
    });

    return segments;
  };

  const analyzeWithAI = async () => {
    if (loanData.length === 0) {
      alert('Please upload loan data first');
      return;
    }

    setLoading(true);
    
    try {
      const eclData = calculateECL(loanData);
      const segmentToAnalyze = selectedSegment === 'all' ? Object.keys(eclData) : [selectedSegment];
      
      const analysisPrompt = `As a credit risk analyst, analyze this loan portfolio data and provide actionable recommendations:

${segmentToAnalyze.map(seg => `
Segment: ${seg}
- Total Loans: ${eclData[seg].totalLoans}
- Default Rate: ${eclData[seg].defaultRate.toFixed(2)}%
- ECL: ${eclData[seg].ecl.toFixed(2)}%
- Average Interest Rate: ${eclData[seg].avgInterest.toFixed(2)}%
- Risk Score: ${eclData[seg].riskScore.toFixed(2)}
`).join('\n')}

Provide:
1. Risk assessment for each segment
2. Specific recommendations on whether to increase interest rates or reduce disbursement
3. Key risk factors identified
4. Suggested actions with quantitative targets

Format your response as JSON with this structure:
{
  "segments": [
    {
      "name": "segment_name",
      "riskLevel": "high/medium/low",
      "recommendation": "increase_interest/reduce_disbursement/maintain/expand",
      "action": "detailed action description",
      "targetInterestRate": number,
      "targetDisbursementChange": percentage
    }
  ],
  "summary": "overall summary",
  "urgentActions": ["action1", "action2"]
}`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4000,
          messages: [
            { 
              role: 'user', 
              content: analysisPrompt
            }
          ]
        })
      });

      const data = await response.json();
      const aiResponse = data.content[0].text;
      
      // Parse AI response
      let parsedAnalysis;
      try {
        const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
        parsedAnalysis = JSON.parse(jsonMatch[0]);
      } catch (e) {
        parsedAnalysis = {
          segments: segmentToAnalyze.map(seg => ({
            name: seg,
            riskLevel: eclData[seg].riskScore > 30 ? 'high' : eclData[seg].riskScore > 15 ? 'medium' : 'low',
            recommendation: eclData[seg].riskScore > 30 ? 'reduce_disbursement' : 'maintain',
            action: aiResponse
          })),
          summary: aiResponse
        };
      }

      const analysisResult = {
        timestamp: new Date().toISOString(),
        eclData,
        aiAnalysis: parsedAnalysis,
        selectedSegment,
        analyzedBy: user.name
      };

      setAnalysis(analysisResult);
      
      // Save report
      const reportId = `report:${Date.now()}`;
      await window.storage.set(reportId, JSON.stringify(analysisResult), false);
      await loadStoredData();
      
    } catch (error) {
      console.error('Analysis error:', error);
      alert('Analysis failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const renderECLChart = () => {
    if (!analysis) return null;

    const chartData = Object.keys(analysis.eclData).map(key => ({
      segment: key,
      ecl: analysis.eclData[key].ecl,
      defaultRate: analysis.eclData[key].defaultRate,
      riskScore: analysis.eclData[key].riskScore
    }));

    return (
      <div className="space-y-6">
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-lg font-semibold mb-4">ECL Curve by Segment</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="segment" angle={-45} textAnchor="end" height={100} />
              <YAxis />
              <Tooltip />
              <Legend />
              <Line type="monotone" dataKey="ecl" stroke="#ef4444" name="ECL %" strokeWidth={2} />
              <Line type="monotone" dataKey="defaultRate" stroke="#f59e0b" name="Default Rate %" strokeWidth={2} />
              <Line type="monotone" dataKey="riskScore" stroke="#8b5cf6" name="Risk Score" strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-lg font-semibold mb-4">Risk Distribution</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="segment" angle={-45} textAnchor="end" height={100} />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="riskScore" fill="#8b5cf6" name="Risk Score" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>
    );
  };

  const renderRecommendations = () => {
    if (!analysis?.aiAnalysis) return null;

    return (
      <div className="space-y-4">
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 className="font-semibold text-blue-900 mb-2">Overall Summary</h3>
          <p className="text-blue-800">{analysis.aiAnalysis.summary}</p>
        </div>

        {analysis.aiAnalysis.urgentActions && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 className="font-semibold text-red-900 mb-2 flex items-center gap-2">
              <AlertCircle className="w-5 h-5" />
              Urgent Actions Required
            </h3>
            <ul className="list-disc list-inside text-red-800 space-y-1">
              {analysis.aiAnalysis.urgentActions.map((action, i) => (
                <li key={i}>{action}</li>
              ))}
            </ul>
          </div>
        )}

        <div className="grid gap-4">
          {analysis.aiAnalysis.segments?.map((segment, i) => {
            const riskColor = segment.riskLevel === 'high' ? 'red' : segment.riskLevel === 'medium' ? 'yellow' : 'green';
            const Icon = segment.recommendation.includes('reduce') ? TrendingDown : TrendingUp;
            
            return (
              <div key={i} className={`bg-${riskColor}-50 border border-${riskColor}-200 rounded-lg p-4`}>
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h4 className="font-semibold text-lg">{segment.name}</h4>
                    <span className={`inline-block px-2 py-1 rounded text-xs font-medium bg-${riskColor}-200 text-${riskColor}-900`}>
                      {segment.riskLevel.toUpperCase()} RISK
                    </span>
                  </div>
                  <Icon className={`w-6 h-6 text-${riskColor}-600`} />
                </div>
                
                <div className="mt-3 space-y-2">
                  <div>
                    <span className="font-medium">Recommendation: </span>
                    <span className="capitalize">{segment.recommendation.replace(/_/g, ' ')}</span>
                  </div>
                  
                  {segment.targetInterestRate && (
                    <div>
                      <span className="font-medium">Target Interest Rate: </span>
                      <span>{segment.targetInterestRate}%</span>
                    </div>
                  )}
                  
                  {segment.targetDisbursementChange && (
                    <div>
                      <span className="font-medium">Disbursement Change: </span>
                      <span>{segment.targetDisbursementChange > 0 ? '+' : ''}{segment.targetDisbursementChange}%</span>
                    </div>
                  )}
                  
                  <div className="mt-2 pt-2 border-t border-gray-200">
                    <span className="font-medium">Action Plan: </span>
                    <p className="text-sm mt-1">{segment.action}</p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const renderReports = () => {
    return (
      <div className="space-y-4">
        <h2 className="text-2xl font-bold">Historical Reports</h2>
        {reports.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            No reports available yet. Run an analysis to create your first report.
          </div>
        ) : (
          <div className="grid gap-4">
            {reports.map((report, i) => (
              <div key={i} className="bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer"
                   onClick={() => setAnalysis(report)}>
                <div className="flex justify-between items-start">
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <FileText className="w-5 h-5 text-blue-600" />
                      <h3 className="font-semibold">
                        Analysis: {report.selectedSegment === 'all' ? 'All Segments' : report.selectedSegment}
                      </h3>
                    </div>
                    <p className="text-sm text-gray-600">
                      Generated: {new Date(report.timestamp).toLocaleString()}
                    </p>
                    <p className="text-sm text-gray-600">By: {report.analyzedBy}</p>
                  </div>
                  <div className="text-right">
                    <div className="text-sm font-medium text-gray-700">
                      {Object.keys(report.eclData).length} Segments
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-6">
            <BarChart3 className="w-16 h-16 text-blue-600 mx-auto mb-4" />
            <h1 className="text-3xl font-bold text-gray-900">Loan ECL Analyzer</h1>
            <p className="text-gray-600 mt-2">AI-Powered Credit Risk Management</p>
          </div>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
              <input
                type="text"
                value={loginForm.username}
                onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="analyst1 / cro"
                required
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input
                type="password"
                value={loginForm.password}
                onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="••••••••"
                required
              />
            </div>
            
            <button
              type="submit"
              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              Sign In
            </button>
          </form>
          
          <div className="mt-6 p-4 bg-gray-50 rounded-lg text-sm">
            <p className="font-medium text-gray-700 mb-2">Demo Credentials:</p>
            <p className="text-gray-600">Analyst: analyst1 / analyst123</p>
            <p className="text-gray-600">CRO: cro / cro123</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <BarChart3 className="w-8 h-8 text-blue-600" />
              <div>
                <h1 className="text-xl font-bold text-gray-900">Loan ECL Analyzer</h1>
                <p className="text-sm text-gray-600">Credit Risk Management Platform</p>
              </div>
            </div>
            
            <div className="flex items-center gap-4">
              <div className="text-right">
                <div className="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <User className="w-4 h-4" />
                  {user.name}
                </div>
                <div className="text-xs text-gray-600 capitalize">{user.role}</div>
              </div>
              <button
                onClick={handleLogout}
                className="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
              >
                <LogOut className="w-4 h-4" />
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setActiveTab('dashboard')}
            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
              activeTab === 'dashboard' 
                ? 'bg-blue-600 text-white' 
                : 'bg-white text-gray-700 hover:bg-gray-50'
            }`}
          >
            Dashboard
          </button>
          <button
            onClick={() => setActiveTab('reports')}
            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
              activeTab === 'reports' 
                ? 'bg-blue-600 text-white' 
                : 'bg-white text-gray-700 hover:bg-gray-50'
            }`}
          >
            Historical Reports
          </button>
        </div>

        {activeTab === 'dashboard' ? (
          <div className="space-y-6">
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Data Upload & Analysis</h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Upload Loan Data (CSV)
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleFileUpload}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  />
                  {loanData.length > 0 && (
                    <p className="mt-2 text-sm text-green-600">✓ {loanData.length} records loaded</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Select Segment to Analyze
                  </label>
                  <select
                    value={selectedSegment}
                    onChange={(e) => setSelectedSegment(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    disabled={loanData.length === 0}
                  >
                    <option value="all">All Segments</option>
                    {loanData.length > 0 && [...new Set(loanData.map(l => l.purpose || l.Purpose))].map(purpose => (
                      <option key={purpose} value={purpose}>{purpose}</option>
                    ))}
                  </select>
                </div>

                <button
                  onClick={analyzeWithAI}
                  disabled={loading || loanData.length === 0}
                  className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>
                      <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                      Analyzing with AI...
                    </>
                  ) : (
                    'Generate ECL Analysis'
                  )}
                </button>
              </div>
            </div>

            {analysis && (
              <>
                <div className="bg-white rounded-lg shadow p-6">
                  <h2 className="text-xl font-bold mb-4">ECL Visualization</h2>
                  {renderECLChart()}
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                  <h2 className="text-xl font-bold mb-4">AI-Powered Recommendations</h2>
                  {renderRecommendations()}
                </div>
              </>
            )}
          </div>
        ) : (
          renderReports()
        )}
      </div>
    </div>
  );
};

export default LoanECLAnalyzer;
